<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Arpeggio</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/black.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h2>Scala and Arpeggio</h2>
					<h4>Audio processing with Scala Native and FS2</h4>
					<section>
						<img src="dist/images/pedalboard/all.jpg">
					</section>
				</section>
				<section>
					<h2>Meet the Team</h2>
					<section data-transition="fade">
						<img src="dist/images/pedalboard/LLM.png">
					</section>
					<section data-transition="fade">
						<img src="dist/images/pedalboard/polytune.png">
					</section>
					<section data-transition="fade">
						<img src="dist/images/pedalboard/tumnus.png">
					</section>
					<section data-transition="fade">
						<img src="dist/images/pedalboard/ACS1.png">
					</section>
					<section data-transition="fade">
						<img src="dist/images/pedalboard/cloudburst.png">
					</section>
				</section>
				<section>
					<h2>Sound</h2>
					<section data-transition="fade">
						<div style="height:480px;width:944px">
							<canvas data-chart="line" >
								<!--
								{
									"data": {
										"labels": ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
										"datasets":[
											{
												"data": [0, 0.12336963808359298, 0.2448543823835012, 0.36259813732466695, 0.4748019637580112, 0.5797515639176074, 0.6758434731908173, 0.7616095585323879, 0.8357394492253214, 0.897100557281821, 0.94475538160411, 0.9779758315248004, 0.9962543508856719, 0.9993116726964553, 0.9871010858946442, 0.9598091490169692, 0.917852839878755, 0.8618731848095703, 0.7927254647804207, 0.7114661480574334, 0.6193367490305086, 0.5177448598286181, 0.4082426445287902, 0.2925031245334108, 0.1722946174379172, 0.04945371992273924, -0.0741427525516458, -0.1966064405292884, -0.3160662917174043, -0.4306971477188216, -0.5387476295779735, -0.6385668960932142, -0.7286298660705874, -0.8075605191627235, -0.8741529192927527, -0.92738963945841, -0.9664573064143603, -0.990759027734458, -0.9999235113880169, -0.9938107384973164, -0.9725141026055468, -0.9363589827705493, -0.8858977722852275, -0.8219014389779586, -0.7453477460383187, -0.6574063133353587, -0.5594207474679531, -0.4528881135719288, -0.33943606252240754, -0.2207979629917065, -0.09878641830579461, 0.024734427279995214, 0.14787736976946816, 0.26876097893061407, 0.3855383435866072, 0.496425289510026, 0.5997276387952726, 0.6938670942289291, 0.7774053531856253, 0.8490660826270787, 0.9077544194609037, 0.9525736983244456, 0.9828391512194237, 0.998088369688552, 0.998088369688552, 0.9828391512194238, 0.9525736983244462, 0.9077544194609041, 0.8490660826270786, 0.7774053531856251, 0.6938670942289302, 0.5997276387952738, 0.49642528951002657, 0.38553834358660694, 0.2687609789306147, 0.14787736976946877, 0.024734427279995825, -0.098786418305794, -0.22079796299170507, -0.3394360625224061, -0.45288811357192904, -0.5594207474679526, -0.6574063133353583, -0.7453477460383182, -0.8219014389779583, -0.8858977722852267, -0.9363589827705491, -0.9725141026055469, -0.9938107384973165, -0.9999235113880169, -0.9907590277344581, -0.9664573064143605, -0.9273896394584102, -0.8741529192927531, -0.8075605191627239, -0.7286298660705869, -0.638566896093216, -0.5387476295779748, -0.43069714771882256, -0.31606629171740447, -0.19660644052928947, -0.07414275255164642, 0.04945371992273951, 0.17229461743791616, 0.2925031245334094, 0.40824264452878967, 0.517744859828618, 0.6193367490305092, 0.7114661480574329, 0.7927254647804198, 0.86187318480957, 0.9178528398787551, 0.959809149016969, 0.9871010858946441, 0.9993116726964553, 0.996254350885672, 0.9779758315248006, 0.9447553816041102, 0.8971005572818211, 0.8357394492253221, 0.7616095585323882, 0.6758434731908172, 0.579751563917608, 0.47480196375801276, 0.362598137324668, 0.24485438238350152, 0.12336963808359255, 0],
												"backgroundColor": "rgba(20,220,220,.8)",
												"pointRadius": 0,
												"tension": 0.45
											}
										]
									},
									"options": {
										"plugins": {
											"legend": {
												"display": false
											}
										},
										"scales": {
											"x": {
												"ticks": false
											}
										}
									}
								}
								-->
							</canvas>
						</div>
					</section>
					<section data-transition="fade">
						<div style="height:480px;width:944px">
							<canvas data-chart="line" >
								<!--
								{
									"data": {
										"labels": ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
										"datasets":[
											{
												"data": [0, 0.12336963808359298, 0.2448543823835012, 0.36259813732466695, 0.4748019637580112, 0.5797515639176074, 0.6758434731908173, 0.7616095585323879, 0.8357394492253214, 0.897100557281821, 0.94475538160411, 0.9779758315248004, 0.9962543508856719, 0.9993116726964553, 0.9871010858946442, 0.9598091490169692, 0.917852839878755, 0.8618731848095703, 0.7927254647804207, 0.7114661480574334, 0.6193367490305086, 0.5177448598286181, 0.4082426445287902, 0.2925031245334108, 0.1722946174379172, 0.04945371992273924, -0.0741427525516458, -0.1966064405292884, -0.3160662917174043, -0.4306971477188216, -0.5387476295779735, -0.6385668960932142, -0.7286298660705874, -0.8075605191627235, -0.8741529192927527, -0.92738963945841, -0.9664573064143603, -0.990759027734458, -0.9999235113880169, -0.9938107384973164, -0.9725141026055468, -0.9363589827705493, -0.8858977722852275, -0.8219014389779586, -0.7453477460383187, -0.6574063133353587, -0.5594207474679531, -0.4528881135719288, -0.33943606252240754, -0.2207979629917065, -0.09878641830579461, 0.024734427279995214, 0.14787736976946816, 0.26876097893061407, 0.3855383435866072, 0.496425289510026, 0.5997276387952726, 0.6938670942289291, 0.7774053531856253, 0.8490660826270787, 0.9077544194609037, 0.9525736983244456, 0.9828391512194237, 0.998088369688552, 0.998088369688552, 0.9828391512194238, 0.9525736983244462, 0.9077544194609041, 0.8490660826270786, 0.7774053531856251, 0.6938670942289302, 0.5997276387952738, 0.49642528951002657, 0.38553834358660694, 0.2687609789306147, 0.14787736976946877, 0.024734427279995825, -0.098786418305794, -0.22079796299170507, -0.3394360625224061, -0.45288811357192904, -0.5594207474679526, -0.6574063133353583, -0.7453477460383182, -0.8219014389779583, -0.8858977722852267, -0.9363589827705491, -0.9725141026055469, -0.9938107384973165, -0.9999235113880169, -0.9907590277344581, -0.9664573064143605, -0.9273896394584102, -0.8741529192927531, -0.8075605191627239, -0.7286298660705869, -0.638566896093216, -0.5387476295779748, -0.43069714771882256, -0.31606629171740447, -0.19660644052928947, -0.07414275255164642, 0.04945371992273951, 0.17229461743791616, 0.2925031245334094, 0.40824264452878967, 0.517744859828618, 0.6193367490305092, 0.7114661480574329, 0.7927254647804198, 0.86187318480957, 0.9178528398787551, 0.959809149016969, 0.9871010858946441, 0.9993116726964553, 0.996254350885672, 0.9779758315248006, 0.9447553816041102, 0.8971005572818211, 0.8357394492253221, 0.7616095585323882, 0.6758434731908172, 0.579751563917608, 0.47480196375801276, 0.362598137324668, 0.24485438238350152, 0.12336963808359255, 0],
												"backgroundColor": "rgba(20,220,220,.8)",
												"tension": 0.45,
												"showLine": false
											}
										]
									},
									"options": {
										"plugins": {
											"legend": {
												"display": false
											}
										}
									}
								}
								-->
							</canvas>
						</div>
					</section>
				</section>
				<section>
					<h2>Digital Signal Processing</h2>
					<h4>The traditional way</h4>
					<section>
						<pre><code data-trim class="language-scala">
							def process(in: InputStream, out: OutputStream): Unit =
								val buffer: Array[Byte] = new Array[Byte](bufferSize)
								while true do
									val readBytes = in.read(buffer, 0, bufferSize)
									f(buffer) // transform the data in the buffer in some way
									out.write(buffer, 0, readBytes)
						</code></pre>
					</section>
				</section>
				<section>
					<h2>FS2</h2>
					<section><img src="dist/images/fs2-logo.png"></section>
					<section>
							<pre><code data-trim class="language-scala">
								Stream[F[_], Element]
							</code></pre>
							<pre class="fragment"><code data-trim class="language-scala">
								Chunk[Element]
							</code></pre>
							<pre class="fragment"><code data-trim class="language-scala">
								Pipe[F[_], Element, Element2] = Stream[F, Element] => Stream[F, Element2]
							</code></pre>
							<pre class="fragment"><code data-trim class="language-scala">
								trait AudioSuite[F[_]] {
									def input: Stream[F, Float]
									def output: Pipe[F, Float, Nothing]
								}

								type Pedal[F[_]] = Pipe[F, Float, Float]
							</code></pre>
				</section>
				</section>
				<section>
					<h4>Implementing an AudioSuite</h4>
					<section>
						<div>
							<div>
								<pre><code data-trim class="language-scala">
									def input: Stream[F, Float] =
										Pull
											.eval(F.blocking {
												val inputBuffer = new Array[Float](FRAMES_PER_BUFFER)
												functions.Pa_ReadStream(
													stream = pStream,
													buffer = inputBuffer.atUnsafe(0).toBytePointer,
													frames = FRAMES_PER_BUFFER.toULong
												)
												Chunk.ArraySlice(inputBuffer, 0, FRAMES_PER_BUFFER)
											})
											.flatMap(Pull.output)
											.streamNoScope
											.repeat
								</code></pre>
							</div>
							<div class="fragment">
								<pre><code data-trim class="language-scala">
									def output: Pipe[F, Float, Nothing] =
										_.chunkN(FRAMES_PER_BUFFER).foreach { chunk =>
											val Chunk.ArraySlice(array, offset, length) =
												chunk.toArraySlice
											F.blocking {
												functions.Pa_WriteStream(
													stream = pStream,
													buffer = array.atUnsafe(offset).toBytePointer,
													frames = length.toULong
												)
												()
											}
										}
								</code></pre>
							</div>
						</div>
					</section>
					<section>
						<pre><code data-trim class="language-scala">
							package arpeggio
	
							import arpeggio.io.portaudio.PortAudioAudioSuite
							import cats.effect.{IO, IOApp}
	
							object Main extends IOApp.Simple:
								def run: IO[Unit] = PortAudioAudioSuite
									.resource[IO]
									.use(audioSuite =>
										audioSuite.input
											.through(somePedal)
											.through(someOtherPedal)
											.through(audioSuite.output)
											.compile
											.drain
									)
						</code></pre>
					</section>
				</section>
				<section>
					<h4>Volume</h4>
					<section data-transition="fade">
						<img src="dist/images/pedalboard/LLM.png">
					</section>
					<section data-transition="fade">
						<div style="height:480px;width:944px">
							<canvas data-chart="line" >
								<!--
								{
									"data": {
										"labels": ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
										"datasets":[
											{
												"data": [0, 0.12336963808359298, 0.2448543823835012, 0.36259813732466695, 0.4748019637580112, 0.5797515639176074, 0.6758434731908173, 0.7616095585323879, 0.8357394492253214, 0.897100557281821, 0.94475538160411, 0.9779758315248004, 0.9962543508856719, 0.9993116726964553, 0.9871010858946442, 0.9598091490169692, 0.917852839878755, 0.8618731848095703, 0.7927254647804207, 0.7114661480574334, 0.6193367490305086, 0.5177448598286181, 0.4082426445287902, 0.2925031245334108, 0.1722946174379172, 0.04945371992273924, -0.0741427525516458, -0.1966064405292884, -0.3160662917174043, -0.4306971477188216, -0.5387476295779735, -0.6385668960932142, -0.7286298660705874, -0.8075605191627235, -0.8741529192927527, -0.92738963945841, -0.9664573064143603, -0.990759027734458, -0.9999235113880169, -0.9938107384973164, -0.9725141026055468, -0.9363589827705493, -0.8858977722852275, -0.8219014389779586, -0.7453477460383187, -0.6574063133353587, -0.5594207474679531, -0.4528881135719288, -0.33943606252240754, -0.2207979629917065, -0.09878641830579461, 0.024734427279995214, 0.14787736976946816, 0.26876097893061407, 0.3855383435866072, 0.496425289510026, 0.5997276387952726, 0.6938670942289291, 0.7774053531856253, 0.8490660826270787, 0.9077544194609037, 0.9525736983244456, 0.9828391512194237, 0.998088369688552, 0.998088369688552, 0.9828391512194238, 0.9525736983244462, 0.9077544194609041, 0.8490660826270786, 0.7774053531856251, 0.6938670942289302, 0.5997276387952738, 0.49642528951002657, 0.38553834358660694, 0.2687609789306147, 0.14787736976946877, 0.024734427279995825, -0.098786418305794, -0.22079796299170507, -0.3394360625224061, -0.45288811357192904, -0.5594207474679526, -0.6574063133353583, -0.7453477460383182, -0.8219014389779583, -0.8858977722852267, -0.9363589827705491, -0.9725141026055469, -0.9938107384973165, -0.9999235113880169, -0.9907590277344581, -0.9664573064143605, -0.9273896394584102, -0.8741529192927531, -0.8075605191627239, -0.7286298660705869, -0.638566896093216, -0.5387476295779748, -0.43069714771882256, -0.31606629171740447, -0.19660644052928947, -0.07414275255164642, 0.04945371992273951, 0.17229461743791616, 0.2925031245334094, 0.40824264452878967, 0.517744859828618, 0.6193367490305092, 0.7114661480574329, 0.7927254647804198, 0.86187318480957, 0.9178528398787551, 0.959809149016969, 0.9871010858946441, 0.9993116726964553, 0.996254350885672, 0.9779758315248006, 0.9447553816041102, 0.8971005572818211, 0.8357394492253221, 0.7616095585323882, 0.6758434731908172, 0.579751563917608, 0.47480196375801276, 0.362598137324668, 0.24485438238350152, 0.12336963808359255, 0],
												"backgroundColor": "rgba(20,220,220,.8)",
												"pointRadius": 0,
												"tension": 0.45
											}
										]
									},
									"options": {
										"plugins": {
											"legend": {
												"display": false
											}
										}
									}
								}
								-->
							</canvas>
						</div>
					</section>
					<section data-transition="fade">
						<div style="height:480px;width:944px">
							<canvas data-chart="line" >
								<!--
								{
									"data": {
										"labels": ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
										"datasets":[
											{
												"data": [0, 0.06168481904179649, 0.1224271911917506, 0.18129906866233347, 0.2374009818790056, 0.2898757819588037, 0.33792173659540864, 0.38080477926619394, 0.4178697246126607, 0.4485502786409105, 0.472377690802055, 0.4889879157624002, 0.49812717544283597, 0.49965583634822763, 0.4935505429473221, 0.4799045745084846, 0.4589264199393775, 0.43093659240478516, 0.39636273239021036, 0.3557330740287167, 0.3096683745152543, 0.25887242991430903, 0.2041213222643951, 0.1462515622667054, 0.0861473087189586, 0.02472685996136962, -0.0370713762758229, -0.0983032202646442, -0.15803314585870215, -0.2153485738594108, -0.26937381478898675, -0.3192834480466071, -0.3643149330352937, -0.40378025958136177, -0.43707645964637637, -0.463694819729205, -0.48322865320718017, -0.495379513867229, -0.49996175569400847, -0.4969053692486582, -0.4862570513027734, -0.46817949138527465, -0.44294888614261374, -0.4109507194889793, -0.37267387301915933, -0.32870315666767935, -0.27971037373397656, -0.2264440567859644, -0.16971803126120377, -0.11039898149585325, -0.049393209152897306, 0.012367213639997607, 0.07393868488473408, 0.13438048946530703, 0.1927691717933036, 0.248212644755013, 0.2998638193976363, 0.34693354711446456, 0.38870267659281266, 0.42453304131353936, 0.45387720973045187, 0.4762868491622228, 0.49141957560971183, 0.499044184844276, 0.499044184844276, 0.4914195756097119, 0.4762868491622231, 0.45387720973045204, 0.4245330413135393, 0.38870267659281255, 0.3469335471144651, 0.2998638193976369, 0.24821264475501328, 0.19276917179330347, 0.13438048946530734, 0.07393868488473439, 0.012367213639997912, -0.049393209152897, -0.11039898149585253, -0.16971803126120305, -0.22644405678596452, -0.2797103737339763, -0.32870315666767913, -0.3726738730191591, -0.41095071948897915, -0.44294888614261335, -0.46817949138527454, -0.48625705130277347, -0.49690536924865825, -0.49996175569400847, -0.49537951386722906, -0.4832286532071802, -0.4636948197292051, -0.43707645964637654, -0.40378025958136193, -0.36431493303529344, -0.319283448046608, -0.2693738147889874, -0.21534857385941128, -0.15803314585870223, -0.09830322026464473, -0.03707137627582321, 0.024726859961369755, 0.08614730871895808, 0.1462515622667047, 0.20412132226439483, 0.258872429914309, 0.3096683745152546, 0.35573307402871646, 0.3963627323902099, 0.430936592404785, 0.45892641993937755, 0.4799045745084845, 0.49355054294732204, 0.49965583634822763, 0.498127175442836, 0.4889879157624003, 0.4723776908020551, 0.44855027864091057, 0.41786972461266103, 0.3808047792661941, 0.3379217365954086, 0.289875781958804, 0.23740098187900638, 0.181299068662334, 0.12242719119175076, 0.06168481904179628, 0],
												"backgroundColor": "rgba(20,220,220,.8)",
												"pointRadius": 0,
												"tension": 0.45
											}
										]
									},
									"options": {
										"plugins": {
											"legend": {
												"display": false
											}
										}
									}
								}
								-->
							</canvas>
						</div>
					</section>
					<section>
						<div>
							<pre><code data-trim class="language-scala">
								def adjustLevel[F[_]](gain: Float): Pedal[F] =
									_.map(_ * gain)
							</code></pre>
						</div>
						<div class="fragment">
							<pre><code data-trim class="language-scala">
								def sweep[F[_]](volumeControlStream: Stream[F, Float]): Pedal[F] =
									_.zipWith(volumeControlStream)(_ * _)
							</code></pre>
						</div>
					</section>
				</section>
				<section>
					<h4>Overdrive</h4>
					<section data-transition="fade">
						<img src="dist/images/pedalboard/tumnus.png">
					</section>
					<section data-transition="fade">
						<div style="height:480px;width:944px">
							<canvas data-chart="line" >
								<!--
								{
									"data": {
										"labels": ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
										"datasets":[
											{
												"data": [0, 0.12336963808359298, 0.2448543823835012, 0.36259813732466695, 0.4748019637580112, 0.5797515639176074, 0.6758434731908173, 0.7616095585323879, 0.8357394492253214, 0.897100557281821, 0.94475538160411, 0.9779758315248004, 0.9962543508856719, 0.9993116726964553, 0.9871010858946442, 0.9598091490169692, 0.917852839878755, 0.8618731848095703, 0.7927254647804207, 0.7114661480574334, 0.6193367490305086, 0.5177448598286181, 0.4082426445287902, 0.2925031245334108, 0.1722946174379172, 0.04945371992273924, -0.0741427525516458, -0.1966064405292884, -0.3160662917174043, -0.4306971477188216, -0.5387476295779735, -0.6385668960932142, -0.7286298660705874, -0.8075605191627235, -0.8741529192927527, -0.92738963945841, -0.9664573064143603, -0.990759027734458, -0.9999235113880169, -0.9938107384973164, -0.9725141026055468, -0.9363589827705493, -0.8858977722852275, -0.8219014389779586, -0.7453477460383187, -0.6574063133353587, -0.5594207474679531, -0.4528881135719288, -0.33943606252240754, -0.2207979629917065, -0.09878641830579461, 0.024734427279995214, 0.14787736976946816, 0.26876097893061407, 0.3855383435866072, 0.496425289510026, 0.5997276387952726, 0.6938670942289291, 0.7774053531856253, 0.8490660826270787, 0.9077544194609037, 0.9525736983244456, 0.9828391512194237, 0.998088369688552, 0.998088369688552, 0.9828391512194238, 0.9525736983244462, 0.9077544194609041, 0.8490660826270786, 0.7774053531856251, 0.6938670942289302, 0.5997276387952738, 0.49642528951002657, 0.38553834358660694, 0.2687609789306147, 0.14787736976946877, 0.024734427279995825, -0.098786418305794, -0.22079796299170507, -0.3394360625224061, -0.45288811357192904, -0.5594207474679526, -0.6574063133353583, -0.7453477460383182, -0.8219014389779583, -0.8858977722852267, -0.9363589827705491, -0.9725141026055469, -0.9938107384973165, -0.9999235113880169, -0.9907590277344581, -0.9664573064143605, -0.9273896394584102, -0.8741529192927531, -0.8075605191627239, -0.7286298660705869, -0.638566896093216, -0.5387476295779748, -0.43069714771882256, -0.31606629171740447, -0.19660644052928947, -0.07414275255164642, 0.04945371992273951, 0.17229461743791616, 0.2925031245334094, 0.40824264452878967, 0.517744859828618, 0.6193367490305092, 0.7114661480574329, 0.7927254647804198, 0.86187318480957, 0.9178528398787551, 0.959809149016969, 0.9871010858946441, 0.9993116726964553, 0.996254350885672, 0.9779758315248006, 0.9447553816041102, 0.8971005572818211, 0.8357394492253221, 0.7616095585323882, 0.6758434731908172, 0.579751563917608, 0.47480196375801276, 0.362598137324668, 0.24485438238350152, 0.12336963808359255, 0],
												"backgroundColor":"rgba(20,220,220,.8)",
												"pointRadius": 0,
												"tension": 0.45
											}
										]
									},
									"options": {
										"plugins": {
											"legend": {
												"display": false
											}
										}
									}
								}
								-->
							</canvas>
						</div>
					</section>
					<section data-transition="fade">
						<div style="height:480px;width:944px">
							<canvas data-chart="line" >
								<!--
								{
									"data": {
										"labels": ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
										"datasets":[
											{
												"label": "",
												"data": [0, 0.23151920856630936, 0.4297550961945966, 0.5937188654580159, 0.7241670227275586, 0.8233912519703032, 0.8949225461270076, 0.943169997416877, 0.9730184714591993, 0.9894117046882882, 0.9969480321382925, 0.999514936002976, 0.9999859701127123, 0.9999995262055232, 0.9998336180149027, 0.9983846954972598, 0.9932518440840146, 0.9809209829253489, 0.9570372670495074, 0.916748216283185, 0.8550954893613381, 0.7674299797782808, 0.6498232322457203, 0.4994481712050137, 0.31490379967775617, 0.09646176943128182, -0.14278835734735706, -0.3545587886009802, -0.5322346826748172, -0.6758942623845148, -0.7872462507800617, -0.8693661114003065, -0.9263582504111327, -0.9629670462150794, -0.9841625122774635, -0.9947277355420203, -0.9988748877070199, -0.9999146044315875, -0.9999999941494923, -0.9999616930420514, -0.9992445254444215, -0.9959498209260007, -0.9869806816305262, -0.9682809025618782, -0.9351522295522353, -0.8826295658575296, -0.8058899222383029, -0.7006685837291173, -0.5636552845040994, -0.39284418552212597, -0.18781408016990175, 0.048857062667120976, 0.27388702304900037, 0.46528949406548603, 0.6224368727977097, 0.7464125109549389, 0.8397820368555922, 0.9062826440041606, 0.9504516232095838, 0.9772189525864642, 0.9914907528710051, 0.9977507459093793, 0.9997055052691302, 0.9999963456695523, 0.9999963456695523, 0.9997055052691302, 0.9977507459093794, 0.9914907528710052, 0.9772189525864642, 0.9504516232095837, 0.9062826440041614, 0.8397820368555932, 0.7464125109549393, 0.6224368727977092, 0.46528949406548703, 0.27388702304900125, 0.04885706266712231, -0.18781408016990075, -0.39284418552212375, -0.5636552845040974, -0.7006685837291176, -0.8058899222383024, -0.8826295658575293, -0.9351522295522351, -0.968280902561878, -0.986980681630526, -0.9959498209260007, -0.9992445254444215, -0.9999616930420514, -0.9999999941494923, -0.9999146044315875, -0.9988748877070199, -0.9947277355420203, -0.9841625122774637, -0.9629670462150797, -0.9263582504111324, -0.869366111400308, -0.7872462507800628, -0.6758942623845159, -0.5322346826748174, -0.3545587886009819, -0.14278835734735806, 0.09646176943128226, 0.3149037996777545, 0.4994481712050115, 0.6498232322457196, 0.7674299797782806, 0.8550954893613385, 0.9167482162831848, 0.957037267049507, 0.9809209829253488, 0.9932518440840146, 0.9983846954972598, 0.9998336180149027, 0.9999995262055232, 0.9999859701127123, 0.999514936002976, 0.9969480321382925, 0.9894117046882882, 0.9730184714591994, 0.9431699974168771, 0.8949225461270075, 0.8233912519703037, 0.7241670227275603, 0.5937188654580172, 0.42975509619459706, 0.2315192085663086, 0],
												"backgroundColor":"rgba(20,220,220,.8)",
												"pointRadius": 0,
												"tension": 0.45
											}
										]
									},
									"options": {
										"plugins": {
											"legend": {
												"display": false
											}
										}
									}
								}
								-->
							</canvas>
						</div>
					</section>
					<section data-transition="fade">
						<div style="height:480px;width:944px">
							<canvas data-chart="line" >
								<!--
								{
									"data": {
										"labels": ["", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""],
										"datasets":[
											{
												"data": [0, 0.12336963808359298, 0.2448543823835012, 0.36259813732466695, 0.4748019637580112, 0.5797515639176074, 0.6758434731908173, 0.7616095585323879, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.7927254647804207, 0.7114661480574334, 0.6193367490305086, 0.5177448598286181, 0.4082426445287902, 0.2925031245334108, 0.1722946174379172, 0.04945371992273924, -0.0741427525516458, -0.1966064405292884, -0.3160662917174043, -0.4306971477188216, -0.5387476295779735, -0.6385668960932142, -0.7286298660705874, -0.8, -0.8, -0.8, -0.8, -0.8, -0.8, -0.8, -0.8, -0.8, -0.8, -0.8, -0.7453477460383187, -0.6574063133353587, -0.5594207474679531, -0.4528881135719288, -0.33943606252240754, -0.2207979629917065, -0.09878641830579461, 0.024734427279995214, 0.14787736976946816, 0.26876097893061407, 0.3855383435866072, 0.496425289510026, 0.5997276387952726, 0.6938670942289291, 0.7774053531856253, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.7774053531856251, 0.6938670942289302, 0.5997276387952738, 0.49642528951002657, 0.38553834358660694, 0.2687609789306147, 0.14787736976946877, 0.024734427279995825, -0.098786418305794, -0.22079796299170507, -0.3394360625224061, -0.45288811357192904, -0.5594207474679526, -0.6574063133353583, -0.7453477460383182, -0.8, -0.8, -0.8, -0.8, -0.8, -0.8, -0.8, -0.8, -0.8, -0.8, -0.8, -0.7286298660705869, -0.638566896093216, -0.5387476295779748, -0.43069714771882256, -0.31606629171740447, -0.19660644052928947, -0.07414275255164642, 0.04945371992273951, 0.17229461743791616, 0.2925031245334094, 0.40824264452878967, 0.517744859828618, 0.6193367490305092, 0.7114661480574329, 0.7927254647804198, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.7616095585323882, 0.6758434731908172, 0.579751563917608, 0.47480196375801276, 0.362598137324668, 0.24485438238350152, 0.12336963808359255, 0],
												"backgroundColor": "rgba(20,220,220,.8)",
												"pointRadius": 0,
												"tension": 0.45
											}
										]
									},
									"options": {
										"plugins": {
											"legend": {
												"display": false
											}
										}
									}
								}
								-->
							</canvas>
						</div>
					</section>
					<section>
						<pre><code data-trim class="language-scala">
							def symmetricClipping[F[_]](threshold: Float): Pedal[F] =
								_.map(sample =>
									Math.min(
										Math.max(sample, -threshold),
										threshold)
									)
						</code></pre>
					</section>
					<section>
						<img src="dist/images/pedalboard/tumnus.png">
					</section>
					<section>
						<img src="dist/images/klon-listing.png">
					</section>
				</section>
				<section>
					<h4>Running pedals in parallel</h4>
					<section>
						<div>
							<pre><code data-trim class="language-scala">
								given pointwiseAdd[F[_]]: Semigroup[Stream[F, Float]] =
									new:
										def combine(
												x: Stream[F, Float],
												y: Stream[F, Float]
										): Stream[F, Float] =
											x.zipWith(y)(_ + _)
							</code></pre>
						</div>
						<div class="fragment">
							<pre><code data-trim class="language-scala">
								def parallel[F[_]: Concurrent](pedal1: Pedal[F], pedal2: Pedal[F]): Pedal[F] =
									stream =>
										for {
											topic <- Stream.eval(UnthrottledChunkedTopic[F, Float])
											pedal1Output <- Stream.resource(topic.subscribeAwait.map(pedal1))
											pedal2Output <- Stream.resource(topic.subscribeAwait.map(pedal2))
											result <- (pedal1Output |+| pedal2Output)
												.concurrently(stream.through(topic.publish))
										} yield result
							</code></pre>
						</div>
					</section>
					<section>
						<pre><code data-trim class="language-scala">
							def blended[F[_]: Concurrent](
									blend: Float,
									threshold: Float
							): Pedal[F] =
								parallel(
									adjustLevel(1 - blend),
									symmetricClipping(threshold) andThen adjustLevel(blend)
								)
						</code></pre>
					</section>
				</section>
				<section>
					<h2>Overdrive Demo</h2>
					<section>
						<pre><code data-trim class="language-scala">
							package arpeggio

							import arpeggio.io.portaudio.PortAudioAudioSuite
							import cats.effect.{IO, IOApp}

							object Main extends IOApp.Simple:
								def run: IO[Unit] = PortAudioAudioSuite
									.resource[IO]
									.use(audioSuite =>
										audioSuite.input
											.through(pedals.overdrive.blended(blend = 0.8, threshold = 0.1))
											.through(audioSuite.output)
											.compile
											.drain
									)
						</code></pre>
					</section>
				</section>
				<section>
					<h4>Reverb</h4>
					<section>
						<img src="dist/images/pedalboard/cloudburst.png">
					</section>
					<section>
						<img src="dist/images/schroeder/paper.png">
					</section>
					<section data-transition="none-out">
						<img src="dist/images/schroeder/reverberator2.png">
					</section>
					<section data-transition="none-in">
						<img src="dist/images/schroeder/reverberator2-boxed.png">
					</section>
					<section data-transition="none-out">
						<img src="dist/images/schroeder/delay.png">
					</section>
					<section data-transition="none-in">
						<img src="dist/images/schroeder/delay-line-boxed.png">
					</section>
					<section>
						<pre><code data-trim class="language-scala">
							def silence(time: Duration): Stream[Pure, Float] =
								val timeInFrames = time.toMicros * SAMPLE_RATE / 1000000
								Stream.constant(0f).take(timeInFrames.toLong)
						</code></pre>
						<pre><code data-trim class="language-scala">
							def delayLine[F[_]: Concurrent](time: Duration): Pedal[F] =
								silence(time) ++ _
						</code></pre>
					</section>
					<section>
						<div class="fig-and-code">
							<img src="dist/images/schroeder/delay.png">
							<div class="code-container code-column">
								<pre><code data-trim class="language-scala">
									def echoStage[F[_]: Concurrent](
											repeatGain: Float,
											delayTime: Duration
									): Pedal[F] = stream =>
										for {
											topic <- Stream.eval(UnthrottledChunkedTopic[F, Float])
											outStream <- Stream.resource(topic.subscribeAwait)
											feedbackStream <- Stream.resource(
												topic.subscribeAwait.map(adjustLevel(repeatGain))
											)
											out <- outStream
												.concurrently(
													(stream |+| feedbackStream)
														.through(delayLine(delayTime))
														.through(topic.publish)
												)
										} yield out
								</code></pre>
							</div>
						</div>
					</section>
					<section>
						<img src="dist/images/schroeder/all-pass.png">
					</section>
					<section>
						<div class="fig-and-code">
							<img src="dist/images/schroeder/all-pass-boxed.png">
							<div class="code-container code-column">
								<pre><code data-trim class="language-scala">
									def allPassStage[F[_]: Concurrent](
											repeatGain: Float,
											delayTime: Duration
									): Pedal[F] =
										parallel(
											adjustLevel(-repeatGain),
											echoStage(repeatGain, delayTime)
												.andThen(adjustLevel(1 - repeatGain * repeatGain))
										)
								</code></pre>
							</div>
						</div>
					</section>
					<section>
						<div class="fig-and-code">
							<img src="dist/images/schroeder/reverberator2-boxed.png" style="max-width:450px">
							<div class="code-column">
								<pre><code data-trim class="language-scala">
									def schroeder[F[_]: Concurrent](
											predelay: Duration,
											decay: Duration,
											mix: Float
									): Pedal[F] =
										parallel(
											identity,
											parallel(
												// Create 4 echo stages with slightly differing delays and gain
												Seq(1f, 1.17f, 1.34f, 1.5f)
													.map(predelay * _)
													.map(t => echoRepeats(gain(decay, t), t)): _*
											)
											.andThen(allPassStage(0.7, 5.millis))
											.andThen(allPassStage(0.7, 1700.micros))
											.andThen(adjustLevel(mix))
										)
								</code></pre>
								<pre><code data-trim class="language-scala">
									def gain(decay: Duration, predelay: Duration): Float =
										Math.pow(2, (-3f * predelay.toMicros) / decay.toMicros).toFloat
								</code></pre>
							</div>
						</div>
					</section>
				</section>
				<section>
					<h2>Reverb Demo</h2>
					<section>
						<pre><code data-trim class="language-scala">
							package arpeggio

							import arpeggio.io.portaudio.PortAudioAudioSuite
							import arpeggio.pedals.reverb
							import cats.effect.{IO, IOApp}

							object Main extends IOApp.Simple:
								def run: IO[Unit] = PortAudioAudioSuite
									.resource[IO]
									.use(audioSuite =>
										audioSuite.input
											.through(
												reverb.schroeder(predelay = 30.millis, decay = 1.second, mix = 0.7)
											)
											.through(audioSuite.output)
											.compile
											.drain
									)
						</code></pre>
					</section>
				</section>
				<section>
					<h2>Read the Code</h2>
					<section>
						<div style="height:480px">
							<img src="dist/images/arpeggio-qr.png">
						</div>
					</section>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="dist/animation.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/reveal.js-plugins@latest/chart/plugin.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.2.0/chart.min.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealChart ],
				chart: {
					defaults: {
						animation: animation,
						scale: {
							beginAtZero: true,
							ticks: { stepSize: 1 },
							grid: { color: "lightgray" } , // color of grid lines
						},
						scales: {
							x: {
								ticks: false
							},
							y: {
								min: -1,
								max: 1,
							}
						}
					},
					line: { borderColor: [ "rgba(20,220,220,.8)" , "rgba(220,120,120,.8)", "rgba(20,120,220,.8)" ]}
				},
			});
		</script>
	</body>
</html>
